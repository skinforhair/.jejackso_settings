#!/bin/bash
source ../lib/db_connection

function cleanTitle(){
 stringZ="$1"
 #stringZ=${stringZ//./\ }
 cutoff=`expr index "$stringZ" [^\(]`

#if I found an open paren "(", then
 if [ $cutoff -gt 1 ]; then
  #eliminate things like (Part 1) and (1).
  oneup=${stringZ:$cutoff:1}
  twoup=${stringZ:$(($cutoff+1)):1}
   if [ "$oneup" = "P" ] || [ "$twoup" = ")" ] || [ "$oneup" = "p" ]; then
    #move up to the next "("
    newString=${stringZ:$cutoff}
    newcut=`expr index "$newString" [^\(]`
    if [ $newcut -gt 1 ]; then
	cutoff=$(($cutoff+$newcut))
    fi
   fi
  stringZ=${stringZ:0:$(($cutoff-2))}
 fi
 stringZ=${stringZ//./\ }
 echo "$stringZ"
} #end cleanTitle

function airDate(){
 stringZ="$1"
 stringZ=${stringZ/./\ }
 cutoff=`expr index "$stringZ" [^\(]`
 
#if I found an open paren "(", then
 if [ $cutoff -gt 1 ]; then
  #eliminate things like (Part 1) and (1).
  oneup=${stringZ:$cutoff:1}
  twoup=${stringZ:$(($cutoff+1)):1}
   if [ "$oneup" = "P" ] || [ "$twoup" = ")" ] || [ "$oneup" = "p" ]; then
    #move up to the next "("
    newString=${stringZ:$cutoff}
    newcut=`expr index "$newString" [^\(]`
    if [ $newcut -gt 1 ]; then
        cutoff=$(($cutoff+$newcut))
    fi
   fi
 fi
 stringZ="${stringZ:$cutoff}"
 stringZ="${stringZ:0:$((${#stringZ}-1))}"

 #now convert it to datetime
  stringZ=${stringZ/Jan/01}
  stringZ=${stringZ/Feb/02}
  stringZ=${stringZ/Mar/03}
  stringZ=${stringZ/Apr/04}
  stringZ=${stringZ/May/05}
  stringZ=${stringZ/Jun/06}
  stringZ=${stringZ/Jul/07}
  stringZ=${stringZ/Aug/08}
  stringZ=${stringZ/Sep/09}
  stringZ=${stringZ/Oct/10}
  stringZ=${stringZ/Nov/11}
  stringZ=${stringZ/Dec/12}

 d=${stringZ:0:2}
 m=${stringZ:3:2}
 y=${stringZ:6:2}
  if [ $y -gt 50 ]; then
	y="19$y"
  else
	y="20$y"
  fi

 echo "$y-$m-$d 00:00:00"
}

function UpdateDB() {
 size="$5"
 size="${size:0:$((${#size}-2))}"
 showID=$(echo "select id from $tvshows where showname='$1'"| mysql $dbOptions)
 foundit=$(echo "select id from $tv_feed where showID=$showID and season=$2 and episode=$3" |mysql $dbOptions)


 if [ "$foundit" != "" ]; then
	echo "Episode already in database!"
 else
    title=$(cleanTitle "$4")
    airdate=$(airDate "$4")
	query="Insert into $tv_feed(id, showID, season, episode, title, airdate) values ('','$showID','$2','$3','$title', '$airdate')"
	insert=$(echo $query |mysql $dbOptions)
	# echo "insert was $insert"
 fi
} #end UpdateDB

if false; then
FoundShowName="Workaholics"
Season="06"
EN="02"
Title="Meth.Head.Actor.(1).(12-Nov-99)"
#UpdateDB "$FoundShowName" "$Season" "$EN" "$Title"

bob=$(cleanTitle "$Title")
echo "$bob"
bob=$(airDate "$Title")
echo "$bob"
fi
